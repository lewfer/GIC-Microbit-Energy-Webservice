<!DOCTYPE html>
<!-- saved from url=(0093)https://www.pythonanywhere.com/user/lewfer/files/home/lewfer/mysite/templates/dashboard2.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="{{url_for('static', filename='main.css')}}">

<!-- Load d3.js -->

<script src="{{url_for('static', filename='d3.v4.js')}}"></script>

<!-- Create a div where the graph will take place -->
</head><body data-new-gr-c-s-check-loaded="14.1086.0" data-gr-ext-installed="">
<h1>National Grid Energy Monitor</h1>
<div class="panel">
  <h2>Power Stations</h2>
  <h3>&nbsp;</h3>
  <div id="userenergy" class="chart"></div>
</div>
<div class="panel">
  <h2>Total Generation</h2>
  <h3 id="totalgenerationvalue">0</h3>
  <div id="totalgeneration" class="chart"></div>
</div>
<div class="panel">
  <h2>Total Available</h2>
  <h3 id="totalavailablevalue">0</h3>
  <div id="totalavailable" class="chart"></div>
</div>

<!-- All time bar chart -->
<script>
    // Data from app
    //let appData = {{appData|safe}}
    /*
    let consumptionRate = {{consumptionRate|safe}}
    let yellowZone = {{yellowZone|safe}}
    let redZone = {{redZone|safe}}
    let totalGenerated = {{totalGenerated|safe}}
    let totalWind = {{totalWind|safe}}
    let totalSolar = {{totalSolar|safe}}
    let totalUsed = {{totalUsed|safe}}*/


    // Function to convert anything that looks like a number to a number
    function convertNumbers(data) {
      data.forEach(function(d) {
          for (let key in d) {
            if (+d[key]===+d[key]) {
              d[key] = +d[key]
            }
          }
        });
    }

    // set the dimensions and margins of the graph
    var margin = {top: 10, right: 30, bottom: 20, left: 50},
        width = 460 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    // Insert the SVG object
    var svgUser = d3.select("#userenergy")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");


    // Insert the SVG object
    var svgTotalGeneration = d3.select("#totalgeneration")
      .append("svg")
        .attr("width", width/2 + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

    // Insert the SVG object
    var svgTotalAvailable = d3.select("#totalavailable")
      .append("svg")
        .attr("width", width/2 + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");

    // Parse the Data
    d3.csv("/getcsvdata", function(data) {
      console.log(data)
      convertNumbers(data)

      // 
      /* Data is a complete hack!  E.g. you may get this:

         generator  wind  solar
         ---------- ----- ------
         total      100   50
         used       150   35
         yr         10000 5000
         mary       80    20
         susan      20    30

         
         Row 0 (total) is the generation amount (wind, solar)
         Row 1 (used) is the total generation (in wind column) and total used (in solar column)
         Row 2 (yr) is the yellow and red zone
         Rows 3 onwards are the data from the users (generators)

         At some point make this work with JSON to avoid this hack.
      */
      
      // Powerstations chart: Skip the total rows in the data and display the rest
      powerstations = data.slice(3)
      powerstations.columns = data.columns
      stackedBar(powerstations)

      // Total generation chart: Select just first row for generation bar
      totalgeneration = [data[0]]
      totalgeneration.columns = data.columns
      bar(totalgeneration, svgTotalGeneration)
      document.getElementById("totalgenerationvalue").innerHTML = totalgeneration[0].wind+ totalgeneration[0].solar

      // Total available chart: Select just second row for available bar, together with the third row for the yellow/red values
      totalavailable = [data[1]]
      totalavailable.columns = data.columns
      //bar(totalavailable, svgTotalAvailable, data[2].wind, data[2].solar)    // hack - wind->yellow, solar->red   
      //bar(totalavailable, svgTotalAvailable, appData.yellowZone, appData.redZone)    // hack - wind->yellow, solar->red   
      //document.getElementById("totalavailablevalue").innerHTML = totalavailable[0].wind - totalavailable[0].solar

      // ------------------------------------------------------------------------------------------
      function bar(data, svg, yellow, red) {

        console.log(data)

        // Get max total bar length
        maxd =  d3.max(data, d => d.wind + d.solar)

        var x = d3.scaleBand()
          .range([ 0, width ])
          .domain(data.map(function(d) { return d.generator; }))
          .padding(0.2);

        if (yellow==undefined) // generation bar
          maxy = maxd
        else
          maxy = Math.max(5000,maxd) // availablebar

        // Add Y axis
        var y = d3.scaleLinear()
          .domain([0, maxy])
          .range([ height, 0]);
        svg.append("g")
          .call(d3.axisLeft(y));

        // Bars
        svg.selectAll("mybar")
          .data(data)
          .enter()
          .append("rect")
            .attr("x", function(d) { return x(d.generator); })
            .attr("y", function(d) { return y(d.wind+d.solar); })
            .attr("width", x.bandwidth())
            .attr("height", function(d) { return height - y(d.wind+d.solar); })
            .attr("fill", function(d) {return (d.wind+d.solar)<red?"#690000":(d.wind+d.solar)<yellow?"#696900":"#69b3a2"})         
      }

      // ------------------------------------------------------------------------------------------
      function stackedBar(data) {
        console.log(data)
        // List of subgroups in the data
        var subgroups = data.columns.slice(1)

        // List of groups in the data
        var groups = d3.map(data, function(d){return(d.generator)}).keys()

        // Get max total bar length
        maxd =  d3.max(data, d => d.wind + d.solar)


        // Add X axis
        var y = d3.scaleBand()
            .domain(groups)
            .range([0, height])
            .padding([0.2])
        svgUser.append("g")
          //.attr("transform", "translate(0," + height + ")")
          .call(d3.axisLeft(y));

        // Add Y axis
        var x = d3.scaleLinear()
          .domain([0, maxd])
          .range([ 0, width ]);
        svgUser.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x));

        // Color palette - one color per subgroup
        var color = d3.scaleOrdinal()
          .domain(subgroups)
          .range(['#387ABE','#ff9200','#4daf4a'])

        // Stack the data
        var stackedData = d3.stack()
          .keys(subgroups)
          (data)

          console.log(stackedData)

        // Show the bars
        svgUser.append("g")
          .selectAll("g")
          // Enter in the stack data = loop key per key = group per group
          .data(stackedData)
          .enter().append("g")
            .attr("fill", function(d) { return color(d.key); })
            .selectAll("rect")
            // enter a second time = loop subgroup per subgroup to add all rectangles
            .data(function(d) { return d; })
            .enter().append("rect")
              .attr("y", function(d) { return y(d.data.generator); })
              .attr("x", function(d) { return x(d[0]); })
              .attr("width", function(d) { return x(d[1])-x(d[0]) ; })
              .attr("height",y.bandwidth())
      }
    })

    // Timer loop to refresh the page
    //setTimeout(function(){window.location.reload(1);}, 5000);

    </script></body>
